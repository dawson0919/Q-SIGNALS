<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Strategy Detail - QuantSignal</title>
    <meta name="description" content="æŸ¥çœ‹ç­–ç•¥è©³ç´°ç¸¾æ•ˆ â€” å³æ™‚å›žæ¸¬æ•¸æ“šã€è³‡é‡‘æ›²ç·šèˆ‡äº¤æ˜“ä¿¡è™Ÿã€‚QuantSignal é‡åŒ–äº¤æ˜“ä¿¡è™Ÿå¹³å°ã€‚" />
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="QuantSignal â€” ç­–ç•¥ç¸¾æ•ˆè©³æƒ…" />
    <meta property="og:description" content="æŸ¥çœ‹ç­–ç•¥è©³ç´°ç¸¾æ•ˆ â€” å³æ™‚å›žæ¸¬æ•¸æ“šã€è³‡é‡‘æ›²ç·šèˆ‡äº¤æ˜“ä¿¡è™Ÿã€‚" />
    <meta property="og:image" content="https://q-signals-production.up.railway.app/og-image.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="QuantSignal â€” ç­–ç•¥ç¸¾æ•ˆè©³æƒ…" />
    <meta name="twitter:image" content="https://q-signals-production.up.railway.app/og-image.png" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#00ff00", "background-dark": "#0a0c0a", "surface-dark": "#161b16", "border-dark": "#2a362a" },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glow-primary {
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }

        /* Premium Content Blur */
        .premium-blur {
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
        }

        .premium-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 12, 10, 0.85);
            backdrop-filter: blur(4px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
    </style>
</head>

<body class="bg-background-dark text-slate-100 min-h-screen pb-24 font-display">
    <!-- Header -->
    <header
        class="sticky top-0 z-50 bg-background-dark/80 backdrop-blur-md border-b border-border-dark px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <a href="index.html"><span
                    class="material-symbols-outlined cursor-pointer text-slate-400">arrow_back</span></a>
            <h1 class="font-bold text-lg tracking-tight">Strategy Detail</h1>
        </div>
        <div class="flex gap-4">
            <span class="material-symbols-outlined text-slate-400">share</span>
        </div>
    </header>

    <main class="max-w-2xl mx-auto">
        <!-- Strategy Identity -->
        <section class="p-4">
            <div class="flex items-center justify-between gap-4 mb-6">
                <div class="flex items-center gap-4">
                    <div
                        class="w-16 h-16 rounded-xl bg-primary/20 flex items-center justify-center border border-primary/30">
                        <span class="material-symbols-outlined text-primary text-3xl">query_stats</span>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold" id="strategyName">Loading...</h2>
                        <div class="flex items-center gap-1.5 text-slate-400 text-sm">
                            <span id="strategySymbol">--</span>
                            <span class="material-symbols-outlined text-primary text-xs"
                                style="font-variation-settings: 'FILL' 1">verified</span>
                        </div>
                    </div>
                </div>
                <button id="subBtn" onclick="toggleSubscription()"
                    class="bg-primary text-black font-bold px-5 py-2 rounded-lg glow-primary hover:opacity-90 transition-all text-sm">Subscribe</button>
            </div>

            <!-- Performance Grid -->
            <div class="grid grid-cols-2 gap-3" id="perfGrid">
                <div class="bg-surface-dark border border-border-dark p-4 rounded-xl">
                    <p class="text-xs text-slate-400 font-medium uppercase tracking-wider mb-1">Total Return (<span
                            id="roiTitlePeriod">--</span>)</p>
                    <p class="text-2xl font-bold text-primary" id="metricReturn">--</p>
                    <p class="text-[10px] text-primary/60 mt-1 flex items-center gap-1"><span
                            class="material-symbols-outlined text-xs">trending_up</span> <span
                            id="returnPeriodLabel">Performance</span></p>
                </div>
                <div class="bg-surface-dark border border-border-dark p-4 rounded-xl">
                    <p class="text-xs text-slate-400 font-medium uppercase tracking-wider mb-1">Max Drawdown</p>
                    <p class="text-2xl font-bold" id="metricDD">--</p>
                    <p class="text-[10px] text-slate-500 mt-1" id="metricDDLabel">Risk Profile</p>
                </div>
                <div class="bg-surface-dark border border-border-dark p-4 rounded-xl">
                    <p class="text-xs text-slate-400 font-medium uppercase tracking-wider mb-1">ç›ˆè™§æ¯”</p>
                    <p class="text-2xl font-bold text-white" id="metricPLRatio">--</p>
                    <p class="text-[10px] text-slate-500 mt-1">Avg Win / Avg Loss</p>
                </div>
                <div class="bg-surface-dark border border-border-dark p-4 rounded-xl">
                    <p class="text-xs text-slate-400 font-medium uppercase tracking-wider mb-1">Win Rate</p>
                    <p class="text-2xl font-bold text-white" id="metricWinRate">--</p>
                    <p class="text-[10px] text-slate-500 mt-1">Historical avg.</p>
                </div>
            </div>
        </section>

        <!-- Admin Only Section -->
        <section class="px-4 py-2 hidden" id="adminNotesSection">
            <div class="bg-primary/5 border border-primary/20 p-4 rounded-xl">
                <div class="flex items-center gap-2 text-primary font-bold text-xs uppercase tracking-widest mb-2">
                    <span class="material-symbols-outlined text-sm">security</span> Admin Insights (Optimization)
                </div>
                <p id="adminNotesContent" class="text-sm text-slate-300 whitespace-pre-line leading-relaxed"></p>
            </div>
        </section>

        <!-- Backtest Chart -->
        <section class="p-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-base" id="equityTitle">Equity Curveï¼ˆå›žæ¸¬ï¼‰4H Kç·š â€¢ æœ€è¿‘ 180 å¤©</h3>
                <div id="periodLabel" class="px-2 py-0.5 rounded bg-primary/10 text-primary text-[10px] font-bold">--
                </div>
            </div>
            <div class="relative bg-surface-dark border border-border-dark rounded-xl overflow-hidden p-4"
                style="height: 280px;">
                <canvas id="equityChart"></canvas>
            </div>
        </section>

        <!-- Live Signal -->
        <section class="px-4 py-2" id="signalSection" style="display:none">
            <div class="bg-primary/5 border border-primary/30 rounded-xl p-5 relative overflow-hidden">
                <!-- Premium Overlay (hidden by default) -->
                <div id="signalPremiumOverlay" class="premium-overlay" style="display:none">
                    <span class="material-symbols-outlined text-primary text-4xl mb-2">lock</span>
                    <p class="text-white font-bold text-sm mb-1">ðŸ”’ Premium Feature</p>
                    <p class="text-slate-400 text-xs text-center px-4 mb-3">Upgrade to Advanced to view live signals</p>
                    <a href="/profile.html"
                        class="bg-primary text-black px-4 py-2 rounded-lg font-bold text-xs hover:opacity-90 transition-all">UPGRADE
                        NOW</a>
                </div>
                <!-- Signal Content -->
                <div id="signalContent">
                    <div class="absolute top-0 right-0 p-3">
                        <span class="flex h-2 w-2">
                            <span
                                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-primary"></span>
                        </span>
                    </div>
                    <p class="text-slate-400 text-xs font-semibold uppercase tracking-widest">Latest Signal</p>
                    <div class="flex items-baseline gap-2 mt-2">
                        <span class="text-3xl font-black italic" id="signalType">--</span>
                        <span class="text-xl font-bold text-white" id="signalPrice">--</span>
                    </div>
                    <div class="flex items-center gap-2 mt-3 text-sm text-slate-400" id="signalTime">
                        <span class="material-symbols-outlined text-sm">schedule</span><span>--</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quant Metrics -->
        <section class="p-4">
            <h3 class="font-bold text-base mb-3">Quant Metrics</h3>
            <div class="bg-surface-dark border border-border-dark rounded-xl divide-y divide-border-dark"
                id="quantMetrics">
                <div class="flex justify-between items-center p-4"><span class="text-slate-400 text-sm">Profit
                        Factor</span><span class="font-bold text-white" id="metricPF">--</span></div>
                <div class="flex justify-between items-center p-4"><span class="text-slate-400 text-sm">ç›ˆè™§æ¯”ä¾‹</span><span
                        class="font-bold text-white" id="metricRF">--</span></div>
                <div class="flex justify-between items-center p-4"><span
                        class="text-slate-400 text-sm">Expectancy</span><span class="font-bold text-white"
                        id="metricExp">--</span></div>
                <div class="flex justify-between items-center p-4"><span class="text-slate-400 text-sm">Avg. Hold
                        Time</span><span class="font-bold text-white" id="metricHold">--</span></div>
                <div class="flex justify-between items-center p-4"><span class="text-slate-400 text-sm">Total
                        Trades</span><span class="font-bold text-white" id="metricTotalTrades">--</span></div>
                <div class="flex justify-between items-center p-4"><span class="text-slate-400 text-sm">Winning /
                        Losing</span><span class="font-bold text-white" id="metricWL">--</span></div>
            </div>
        </section>

        <!-- Recent Trades -->
        <section class="p-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-base">Recent Trades</h3>
            </div>
            <div class="space-y-3" id="tradeList"></div>
        </section>


    </main>

    <!-- Bottom Nav -->
    <nav
        class="fixed bottom-0 left-0 right-0 bg-background-dark border-t border-border-dark px-6 py-3 flex justify-between items-center z-50">
        <a href="index.html" class="flex flex-col items-center gap-1 text-slate-500"><span
                class="material-symbols-outlined">home</span><span class="text-[10px]">Home</span></a>
        <a id="adminNavLink" href="admin.html" class="hidden flex-col items-center gap-1 text-slate-500"><span
                class="material-symbols-outlined">terminal</span><span class="text-[10px]">Admin</span></a>
        <a href="profile.html" class="flex flex-col items-center gap-1 text-slate-500"><span
                class="material-symbols-outlined">person</span><span class="text-[10px]">Profile</span></a>
    </nav>

    <script>
        let equityChart = null;
        const params = new URLSearchParams(window.location.search);
        const strategyId = params.get('strategy') || 'ma60';
        const symbol = params.get('symbol') || 'BTCUSDT';
        const timeframe = params.get('timeframe') || '4h';

        // Update Title dynamically
        const days = timeframe === '1h' ? 45 : 180;
        const tfLabel = timeframe.toUpperCase();
        const titleEl = document.getElementById('equityTitle');
        if (titleEl) titleEl.textContent = `Equity Curveï¼ˆå›žæ¸¬ï¼‰${tfLabel} Kç·š â€¢ æœ€è¿‘ ${days} å¤©`;

        let userRole = 'standard'; // Track user role
        let strategyCategory = 'Basic'; // Track strategy category

        async function loadData() {
            // ... (Auth Logic) ... 
            const { user, token } = await getUser();

            // Get user role
            if (user && token) {
                try {
                    const profileRes = await fetch('/api/profile', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const profile = await profileRes.json();
                    userRole = profile.role || 'standard';
                } catch (e) {
                    console.error('Profile fetch error:', e);
                }
            }

            const isAdmin = userRole === 'admin';
            const isPlatinum = userRole === 'platinum';
            const isAdvanced = userRole === 'advanced';
            const isSPX = symbol === 'SPXUSDT';

            // Base Visibility Logic
            if (isSPX) {
                // SPX is restricted to Admin or Platinum
                if (isAdmin || isPlatinum) {
                    document.getElementById('signalSection').style.display = 'block';
                    document.getElementById('signalPremiumOverlay').style.display = 'none';
                } else {
                    // Show chart but hide/blur signal for SPX
                    document.getElementById('signalSection').style.display = 'block';
                    document.getElementById('signalPremiumOverlay').style.display = 'flex';
                    const link = document.querySelector('#signalPremiumOverlay a');
                    if (link) link.textContent = 'UPGRADE TO PLATINUM';
                }
            } else {
                // Original logic for other assets (GOLD, BTC, etc.)
                if (strategyCategory === 'Premium') {
                    if (isAdmin || isAdvanced || isPlatinum) {
                        document.getElementById('signalSection').style.display = 'block';
                        document.getElementById('signalPremiumOverlay').style.display = 'none';
                    } else {
                        document.getElementById('signalSection').style.display = 'block';
                        document.getElementById('signalPremiumOverlay').style.display = 'flex';
                    }
                } else {
                    // Basic strategy
                    document.getElementById('signalSection').style.display = 'block';
                    document.getElementById('signalPremiumOverlay').style.display = 'none';
                }
            }

            // Load strategy info
            try {
                const sHeaders = token ? { 'Authorization': `Bearer ${token}` } : {};
                const sRes = await fetch(`/api/strategies/${strategyId}`, { headers: sHeaders });
                const strat = await sRes.json();
                strategyCategory = strat.category || 'Basic'; // Store category
                document.getElementById('strategyName').textContent = strat.name || strategyId;
                document.getElementById('strategySymbol').textContent = `${symbol.replace('USDT', '/USDT')} â€¢ ${tfLabel} â€¢ QuantSignal`;

                // Show admin notes if available
                if (strat.adminNotes) {
                    document.getElementById('adminNotesSection').classList.remove('hidden');
                    document.getElementById('adminNotesContent').innerText = strat.adminNotes;
                }
            } catch (e) { }

            // Check subscription status
            if (user && token) {
                checkSubStatus(token);
            }

            // Run backtest
            try {
                const res = await fetch('/api/backtest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strategyId, symbol, timeframe })
                });
                const data = await res.json();
                if (data.summary) renderReport(data);
            } catch (err) {
                console.error('Backtest error:', err);
            }
        }

        async function checkSubStatus(token) {
            try {
                const res = await fetch('/api/subscriptions', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const subs = await res.json();
                const isSubscribed = subs.some(s => s.strategy_id === strategyId);
                const btn = document.getElementById('subBtn');
                if (isSubscribed) {
                    btn.textContent = 'Unsubscribe';
                    btn.className = 'bg-slate-700 text-slate-300 font-bold px-5 py-2 rounded-lg hover:bg-slate-600 transition-all text-sm';
                } else {
                    btn.textContent = 'Subscribe';
                    btn.className = 'bg-primary text-black font-bold px-5 py-2 rounded-lg glow-primary hover:opacity-90 transition-all text-sm';
                }
            } catch (e) { }
        }

        async function toggleSubscription() {
            const { user, token } = await getUser();
            if (!user) {
                if (confirm('Please login to subscribe to strategy signals. Go to login page?')) {
                    window.location.href = '/login.html';
                }
                return;
            }

            const btn = document.getElementById('subBtn');
            const isSubscribed = btn.textContent === 'Unsubscribe';
            const endpoint = isSubscribed ? '/api/unsubscribe' : '/api/subscribe';

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ strategyId, symbol, timeframe })
                });

                if (res.ok) {
                    checkSubStatus(token);
                } else {
                    const data = await res.json();
                    alert(data.error || 'Operation failed');
                }
            } catch (e) {
                alert('Request failed. Please try again later.');
            }
        }

        function renderReport(data) {
            const s = data.summary;
            document.getElementById('metricReturn').textContent = `${s.totalReturn > 0 ? '+' : ''}${s.totalReturn}%`;
            document.getElementById('metricDD').textContent = `-${s.maxDrawdown}%`;
            document.getElementById('metricDDLabel').textContent = s.maxDrawdown < 15 ? 'Low Risk Profile' : s.maxDrawdown < 30 ? 'Medium Risk' : 'High Risk';
            document.getElementById('metricPLRatio').textContent = s.plRatio ? s.plRatio.toFixed(2) : '--';
            document.getElementById('metricWinRate').textContent = `${s.winRate}%`;
            document.getElementById('metricPF').textContent = s.profitFactor;
            document.getElementById('metricRF').textContent = s.plRatio ? s.plRatio.toFixed(2) : '--';
            document.getElementById('metricExp').textContent = `${s.expectancy}% / trade`;
            document.getElementById('metricHold').textContent = `${s.avgHoldDays} Days`;
            document.getElementById('metricTotalTrades').textContent = s.totalTrades;
            document.getElementById('metricWL').textContent = `${s.winningTrades} / ${s.losingTrades}`;
            document.getElementById('periodLabel').textContent = `${s.period.startDate} â†’ ${s.period.endDate}`;

            // Set ROI Period Label based on timeframe
            const roiDays = timeframe === '1h' ? 45 : 180;
            const returnPeriodLabel = document.getElementById('returnPeriodLabel');
            if (returnPeriodLabel) returnPeriodLabel.textContent = `æœ€è¿‘ ${roiDays} å¤©ç¸¾æ•ˆ`;

            const roiTitlePeriod = document.getElementById('roiTitlePeriod');
            if (roiTitlePeriod) roiTitlePeriod.textContent = `${roiDays}d`;

            // Show latest signal from recent trades
            if (data.recentTrades && data.recentTrades.length > 0) {
                const latest = data.recentTrades[0];
                document.getElementById('signalSection').style.display = 'block';
                const signalType = document.getElementById('signalType');

                // Simplified: Signal is the type of the last entry
                const isBuy = latest.type === 'LONG';
                signalType.textContent = isBuy ? 'BUY' : 'SELL';
                signalType.className = `text-3xl font-black italic ${isBuy ? 'text-primary' : 'text-red-500'}`;

                const price = latest.entryPrice;
                const precision = price < 1 ? 4 : 2;
                document.getElementById('signalPrice').textContent = `@ $${price.toLocaleString('en-US', { minimumFractionDigits: precision, maximumFractionDigits: precision })}`;
                const entryDate = new Date(latest.entryTime);
                const timeStr = entryDate.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false });
                document.getElementById('signalTime').querySelector('span:last-child').textContent = `Signal Time: ${timeStr}`;

                // Apply blur for non-premium users ONLY on Premium strategies
                const isPremiumStrategy = strategyCategory === 'Premium';
                const isPremiumUser = userRole === 'advanced' || userRole === 'admin';

                if (isPremiumStrategy && !isPremiumUser) {
                    document.getElementById('signalContent').classList.add('premium-blur');
                    document.getElementById('signalPremiumOverlay').style.display = 'flex';
                }
            }

            // Render equity chart
            renderChart(data.equityCurve);

            // Render trade list
            renderTrades(data.recentTrades);
        }

        function renderChart(equityCurve) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            if (equityChart) equityChart.destroy();

            const labels = equityCurve.map(p => {
                const d = new Date(p.time);
                return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:00`;
            });
            const values = equityCurve.map(p => p.equity);

            equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Equity ($)',
                        data: values,
                        borderColor: '#00ff00',
                        backgroundColor: 'rgba(0,255,0,0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `$${ctx.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 2 })}`
                            }
                        }
                    },
                    scales: {
                        x: { display: true, ticks: { color: '#666', maxTicksLimit: 8 }, grid: { color: '#2a362a33' } },
                        y: { display: true, ticks: { color: '#666', callback: v => '$' + v.toLocaleString() }, grid: { color: '#2a362a33' } }
                    }
                }
            });
        }

        function renderTrades(trades) {
            const container = document.getElementById('tradeList');
            container.innerHTML = '';
            if (!trades) return;

            // For non-premium users on Premium strategies, skip the first 2 trades
            const isPremiumUser = userRole === 'advanced' || userRole === 'admin';
            const isPremiumStrategy = strategyCategory === 'Premium';
            const shouldHideTrades = isPremiumStrategy && !isPremiumUser;
            const tradesToShow = shouldHideTrades ? trades.slice(2, 8) : trades.slice(0, 8);

            // Show premium notice for hidden trades
            if (shouldHideTrades && trades.length > 0) {
                const notice = document.createElement('div');
                notice.className = 'bg-primary/5 border border-primary/30 rounded-xl p-4 mb-3 text-center';
                notice.innerHTML = `
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <span class="material-symbols-outlined text-primary text-xl">lock</span>
                        <p class="text-white font-bold text-sm">2 Most Recent Trades Hidden</p>
                    </div>
                    <p class="text-slate-400 text-xs mb-3">Upgrade to Advanced to view all recent trades</p>
                    <a href="/profile.html" class="inline-block bg-primary text-black px-4 py-2 rounded-lg font-bold text-xs hover:opacity-90 transition-all">UPGRADE NOW</a>
                `;
                container.appendChild(notice);
            }

            tradesToShow.forEach(t => {
                const isProfit = t.pnlPercent > 0;
                const isLong = t.type === 'LONG';
                const badgeBg = isLong ? 'bg-primary/20 text-primary' : 'bg-orange-500/20 text-orange-400';
                const div = document.createElement('div');
                div.className = 'bg-surface-dark border border-border-dark p-4 rounded-xl flex justify-between items-center';
                div.innerHTML = `
          <div class="flex flex-col gap-1">
            <div class="flex items-center gap-2">
              <span class="px-1.5 py-0.5 rounded ${badgeBg} text-[10px] font-bold">${t.type}</span>
              <span class="text-sm font-bold">${symbol.replace('USDT', '/USDT')}</span>
            </div>
            <p class="text-[11px] text-slate-500">${t.entryDate?.split('T')[0] || '--'} â†’ ${t.exitDate?.split('T')[0] || '--'}</p>
          </div>
          <div class="text-right">
            <p class="${isProfit ? 'text-primary' : 'text-red-500'} font-bold text-sm">${isProfit ? '+' : ''}${t.pnlPercent}%</p>
            <p class="text-[10px] text-slate-500">$${t.entryPrice?.toFixed(0)} â†’ $${t.exitPrice?.toFixed(0)}</p>
          </div>
        `;
                container.appendChild(div);
            });
        }

        async function init() {
            if (typeof updateHeaderAuth === 'function') updateHeaderAuth();
            await loadData();

            // Show admin nav link for admins only
            const { user, token } = await getUser();
            if (user && token && (userRole === 'admin' || isAdmin(user))) {
                const adminLink = document.getElementById('adminNavLink');
                if (adminLink) {
                    adminLink.classList.remove('hidden');
                    adminLink.classList.add('flex');
                }
            }
        }

        init();
    </script>
</body>

</html>