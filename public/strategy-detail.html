<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>ç­–ç•¥è©³æƒ… - QuantSignal</title>
    <meta name="description" content="æŸ¥çœ‹ç­–ç•¥è©³ç´°ç¸¾æ•ˆ â€” å³æ™‚å›æ¸¬æ•¸æ“šã€è³‡é‡‘æ›²ç·šèˆ‡äº¤æ˜“ä¿¡è™Ÿã€‚QuantSignal é‡åŒ–äº¤æ˜“ä¿¡è™Ÿå¹³å°ã€‚" />
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="QuantSignal â€” ç­–ç•¥ç¸¾æ•ˆè©³æƒ…" />
    <meta property="og:description" content="æŸ¥çœ‹ç­–ç•¥è©³ç´°ç¸¾æ•ˆ â€” å³æ™‚å›æ¸¬æ•¸æ“šã€è³‡é‡‘æ›²ç·šèˆ‡äº¤æ˜“ä¿¡è™Ÿã€‚" />
    <meta property="og:image" content="https://q-signals-production.up.railway.app/og-image.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="QuantSignal â€” ç­–ç•¥ç¸¾æ•ˆè©³æƒ…" />
    <meta name="twitter:image" content="https://q-signals-production.up.railway.app/og-image.png" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#EAB308", "background-dark": "#0a0c0a", "surface-dark": "#161b16", "border-dark": "#2a362a" },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glow-primary {
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.3);
        }

        /* Premium Content Blur */
        .premium-blur {
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
        }

        .premium-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 12, 10, 0.85);
            backdrop-filter: blur(4px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .glow-indigo {
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.4);
        }
    </style>
</head>

<body class="bg-background-dark text-slate-100 min-h-screen pb-24 font-display">
    <!-- Header -->
    <header
        class="sticky top-0 z-50 bg-background-dark/80 backdrop-blur-md border-b border-border-dark px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <a href="index.html"><span
                    class="material-symbols-outlined cursor-pointer text-slate-400">arrow_back</span></a>
            <div class="flex flex-col">
                <h1 class="font-bold text-lg tracking-tight leading-none">ç­–ç•¥è©³æƒ…</h1>
                <span class="text-[9px] text-slate-500 font-bold uppercase mt-0.5">Strategy Detail</span>
            </div>
        </div>
        <div class="flex gap-4">
            <span class="material-symbols-outlined text-slate-400">share</span>
        </div>
    </header>

    <main class="max-w-2xl mx-auto">
        <!-- Strategy Identity -->
        <section class="p-4">
            <div class="flex items-center justify-between gap-4 mb-6">
                <div class="flex items-center gap-4">
                    <div
                        class="w-16 h-16 rounded-xl bg-primary/20 flex items-center justify-center border border-primary/30">
                        <span class="material-symbols-outlined text-primary text-3xl">query_stats</span>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold" id="strategyName">è¼‰å…¥ä¸­...</h2>
                        <div class="flex items-center gap-1.5 text-slate-400 text-sm">
                            <span id="strategySymbol">--</span>
                            <span class="material-symbols-outlined text-primary text-xs"
                                style="font-variation-settings: 'FILL' 1">verified</span>
                            <span id="categoryBadge"
                                class="text-[9px] bg-primary text-black px-2 py-0.5 rounded-full font-bold uppercase ml-2">--</span>
                        </div>
                    </div>
                </div>
                <button id="subBtn" onclick="toggleSubscription()"
                    class="flex flex-col items-center bg-primary text-black font-bold px-5 py-1.5 rounded-lg glow-primary hover:opacity-90 transition-all leading-none">
                    <span class="text-sm">è¨‚é–±</span>
                    <span class="text-[8px] font-bold opacity-70">Subscribe</span>
                </button>
            </div>

            <!-- Performance Grid -->
            <div class="grid grid-cols-2 gap-3" id="perfGrid">
                <div class="bg-surface-dark border border-border-dark p-4 rounded-xl">
                    <p class="text-xs text-slate-400 font-medium uppercase tracking-wider mb-1 leading-none">ç¸½å ±é…¬ç‡
                        (<span id="roiTitlePeriod">--</span>)</p>
                    <span class="text-[8px] text-slate-600 font-bold uppercase block mb-1">Total Return</span>
                    <p class="text-2xl font-bold text-primary" id="metricReturn">--</p>
                    <p class="text-[10px] text-primary/60 mt-1 flex items-center gap-1"><span
                            class="material-symbols-outlined text-xs">trending_up</span> <span
                            id="returnPeriodLabel">å›æ¸¬ç¸¾æ•ˆ</span></p>
                    <p class="text-[9px] text-slate-600 mt-1.5 leading-snug">ğŸ“ å…¬å¼ï¼š(æœŸæœ«æ·¨å€¼ âˆ’ åˆå§‹è³‡é‡‘) Ã· åˆå§‹è³‡é‡‘ Ã—
                        100%<br>æ¡ç”¨è¤‡åˆ©è¨ˆç®—ï¼Œæ¯ç­†äº¤æ˜“ä»¥ç•¶å‰å¸³æˆ¶æ·¨å€¼æŠ•å…¥</p>
                </div>
                <div class="bg-surface-dark border border-border-dark p-4 rounded-xl">
                    <p class="text-xs text-slate-400 font-medium uppercase tracking-wider mb-1 leading-none">æœ€å¤§å›æ’¤</p>
                    <span class="text-[8px] text-slate-600 font-bold uppercase block mb-1">Max Drawdown</span>
                    <p class="text-2xl font-bold" id="metricDD">--</p>
                    <p class="text-[10px] text-slate-500 mt-1" id="metricDDLabel">é¢¨éšªè©•ä¼°</p>
                </div>
                <div class="bg-surface-dark border border-border-dark p-4 rounded-xl">
                    <p class="text-xs text-slate-400 font-medium uppercase tracking-wider mb-1 leading-none">ç›ˆè™§æ¯” PF</p>
                    <span class="text-[8px] text-slate-600 font-bold uppercase block mb-1">Profit Factor</span>
                    <p class="text-2xl font-bold text-white" id="metricPLRatio">--</p>
                    <p class="text-[10px] text-slate-500 mt-1">ç´¯ç©ç›ˆåˆ© / ç´¯ç©è™§æ</p>
                </div>
                <div class="bg-surface-dark border border-border-dark p-4 rounded-xl">
                    <p class="text-xs text-slate-400 font-medium uppercase tracking-wider mb-1 leading-none">å‹ç‡
                    </p>
                    <span class="text-[8px] text-slate-600 font-bold uppercase block mb-1">Win Rate</span>
                    <p class="text-2xl font-bold text-white" id="metricWinRate">--</p>
                    <p class="text-[10px] text-slate-500 mt-1">æ­·å²å¹³å‡å‹ç‡</p>
                </div>
            </div>
        </section>



        <!-- Backtest Chart -->
        <section class="p-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-base" id="equityTitle">è³‡é‡‘æ›²ç·š Equity Curveï¼ˆå›æ¸¬ï¼‰4H Kç·š â€¢ æœ€è¿‘ 180 å¤©</h3>
                <div id="periodLabel" class="px-2 py-0.5 rounded bg-primary/10 text-primary text-[10px] font-bold">--
                </div>
            </div>
            <div class="relative bg-surface-dark border border-border-dark rounded-xl overflow-hidden p-4"
                style="height: 280px;">
                <canvas id="equityChart"></canvas>
            </div>
        </section>

        <!-- Live Signal -->
        <section class="px-4 py-2" id="signalSection" style="display:none">
            <div class="bg-primary/5 border border-primary/30 rounded-xl p-5 relative overflow-hidden">
                <!-- Premium Overlay (hidden by default) -->
                <div id="signalPremiumOverlay" class="premium-overlay" style="display:none">
                    <span class="material-symbols-outlined text-primary text-4xl mb-2">lock</span>
                    <p class="text-white font-bold text-sm mb-1 leading-none">ğŸ”’ é€²éšåŠŸèƒ½</p>
                    <span class="text-[9px] text-slate-500 font-bold uppercase mb-2">Premium Feature</span>
                    <p class="text-slate-400 text-xs text-center px-4 mb-3">å‡ç´šé€²éšæœƒå“¡ä»¥æŸ¥çœ‹å³æ™‚ä¿¡è™Ÿ</p>
                    <a href="/profile.html"
                        class="bg-primary text-black px-4 py-2 rounded-lg font-bold text-xs hover:opacity-90 transition-all">ç«‹å³å‡ç´š <span class="text-[10px] block opacity-70">UPGRADE NOW</span></a>
                </div>
                <!-- Signal Content -->
                <div id="signalContent">
                    <div class="absolute top-0 right-0 p-3">
                        <span class="flex h-2 w-2">
                            <span
                                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-primary"></span>
                        </span>
                    </div>
                    <p class="text-slate-400 text-xs font-semibold uppercase tracking-widest leading-none">æœ€æ–°ä¿¡è™Ÿ
                    </p>
                    <span class="text-[9px] text-slate-600 font-bold uppercase">Latest Signal</span>
                    <div class="flex items-baseline gap-2 mt-2">
                        <span class="text-3xl font-black italic" id="signalType">--</span>
                        <span class="text-xl font-bold text-white" id="signalPrice">--</span>
                    </div>
                    <div class="flex items-center gap-2 mt-3 text-sm text-slate-400" id="signalTime">
                        <span class="material-symbols-outlined text-sm">schedule</span><span>--</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quant Metrics -->
        <section class="p-4">
            <h3 class="font-bold text-base leading-none">é‡åŒ–æŒ‡æ¨™</h3>
            <span class="text-[9px] text-slate-600 font-bold uppercase">Quant Metrics</span>
            <div class="bg-surface-dark border border-border-dark rounded-xl divide-y divide-border-dark mt-3"
                id="quantMetrics">
                <div class="flex justify-between items-center p-4"><span class="text-slate-400 text-sm">ç›ˆè™§æ¯” PF</span><span class="font-bold text-white" id="metricPF">--</span></div>
                <div class="flex justify-between items-center p-4"><span class="text-slate-400 text-sm">ç›ˆè™§æ¯”ä¾‹</span><span
                        class="font-bold text-white" id="metricRF">--</span></div>
                <div class="flex justify-between items-center p-4"><span
                        class="text-slate-400 text-sm">æœŸæœ›å€¼</span><span class="font-bold text-white"
                        id="metricExp">--</span></div>
                <div class="flex justify-between items-center p-4"><span class="text-slate-400 text-sm">å¹³å‡æŒå€‰å¤©æ•¸</span><span class="font-bold text-white" id="metricHold">--</span></div>
                <div class="flex justify-between items-center p-4"><span class="text-slate-400 text-sm">ç¸½äº¤æ˜“æ¬¡æ•¸</span><span class="font-bold text-white" id="metricTotalTrades">--</span></div>
                <div class="flex justify-between items-center p-4"><span class="text-slate-400 text-sm">ç²åˆ© / è™§æ</span><span class="font-bold text-white" id="metricWL">--</span></div>
            </div>
        </section>

        <!-- Recent Trades -->
        <section class="p-4">
            <div class="flex flex-col items-start mb-2">
                <h3 class="font-bold text-base leading-none">è¿‘æœŸäº¤æ˜“</h3>
                <span class="text-[9px] text-slate-600 font-bold uppercase mt-0.5">Recent Trades</span>
            </div>
            <div class="bg-slate-800/50 border border-slate-700/50 rounded-lg px-3 py-2 mb-4">
                <p class="text-[10px] text-slate-500 leading-relaxed flex items-start gap-1.5">
                    <span class="material-symbols-outlined text-[12px] text-slate-600 mt-0.5 shrink-0">info</span>
                    <span>ä¸‹æ–¹æ¯ç­†äº¤æ˜“é¡¯ç¤ºçš„ % ç‚º<strong class="text-slate-400">å–®ç­†åƒ¹æ ¼è®Šå‹•å ±é…¬ç‡</strong>ï¼ˆé€²å‡ºå ´åƒ¹å·®æ¯”ï¼‰ï¼Œéå¸³æˆ¶ç¸½å ±é…¬ç‡ã€‚å› è¤‡åˆ©æ•ˆæ‡‰ï¼ŒåŠ ç¸½ä¸ç­‰æ–¼ä¸Šæ–¹
                        Total Returnã€‚</span>
                </p>
            </div>
            <div class="space-y-3" id="tradeList"></div>
        </section>


    </main>

    <nav
        class="fixed bottom-0 left-0 right-0 bg-background-dark/95 backdrop-blur-md border-t border-border-dark px-6 pb-6 pt-3 flex justify-between items-center z-50">
        <a href="index.html" class="flex flex-col items-center gap-1 text-slate-500">
            <span class="material-symbols-outlined">home</span>
            <span class="text-[10px] font-black leading-none">é¦–é </span>
            <span class="text-[8px] font-bold opacity-60">HOME</span>
        </a>
        <a id="adminNavLink" href="admin.html" class="hidden flex-col items-center gap-1 text-slate-500">
            <span class="material-symbols-outlined">terminal</span>
            <span class="text-[10px] font-black leading-none">ç®¡ç†ç«¯</span>
            <span class="text-[8px] font-bold opacity-60">ADMIN</span>
        </a>
        <a href="profile.html" class="flex flex-col items-center gap-1 text-slate-500">
            <span class="material-symbols-outlined">person</span>
            <span class="text-[10px] font-black leading-none">å€‹äººè³‡æ–™</span>
            <span class="text-[8px] font-bold opacity-60">PROFILE</span>
        </a>
    </nav>

    <script>
        let equityChart = null;
        const params = new URLSearchParams(window.location.search);
        const strategyId = params.get('strategy') || 'ma60';
        const symbol = params.get('symbol') || 'BTCUSDT';
        const timeframe = params.get('timeframe') || '4h';

        // Update Title dynamically
        const isIndexSymbol = ['SPXUSDT', 'SPYUSDT', 'NQUSDT', 'ESUSDT'].includes(symbol);
        const days = isIndexSymbol ? 90 : (timeframe === '1h' ? 45 : 180);
        const tfLabel = timeframe.toUpperCase();
        const titleEl = document.getElementById('equityTitle');
        if (titleEl) titleEl.textContent = `è³‡é‡‘æ›²ç·š Equity Curve ${tfLabel} Kç·š â€¢ ${isIndexSymbol ? '90å¤©å›æ¸¬' : 'æœ€è¿‘ ' + days + ' å¤©'}`;

        const roiLabelEl = document.getElementById('roiTitlePeriod');
        if (roiLabelEl) roiLabelEl.textContent = isIndexSymbol ? '90å¤©å›æ¸¬' : `${days}d`;

        let userRole = 'standard'; // Track user role
        let strategyCategory = 'Basic'; // Track strategy category

        async function loadData() {
            // ... (Auth Logic) ... 
            const { user, token } = await getUser();

            // Get user role
            if (user && token) {
                try {
                    const profileRes = await fetch('/api/profile', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const profile = await profileRes.json();
                    userRole = profile.role || 'standard';
                } catch (e) {
                    console.error('Profile fetch error:', e);
                }
            }

            const isAdmin = userRole === 'admin';
            const isPlatinum = userRole === 'platinum';
            const isAdvanced = userRole === 'advanced';
            // Load strategy info
            try {
                const sHeaders = token ? { 'Authorization': `Bearer ${token}` } : {};
                const sRes = await fetch(`/api/strategies/${strategyId}`, { headers: sHeaders });
                const strat = await sRes.json();

                const isIndexAsset = ['SPXUSDT', 'NQUSDT', 'ESUSDT'].includes(symbol);
                strategyCategory = isIndexAsset ? 'Platinum' : (strat.category || 'Basic');
                const isPlatinumAsset = strategyCategory === 'Platinum';

                document.getElementById('strategyName').textContent = strat.name || strategyId;
                document.getElementById('strategySymbol').textContent = `${symbol.replace('USDT', '/USDT')} â€¢ ${tfLabel} â€¢ QuantSignal`;

                // Update Badge color
                const badge = document.getElementById('categoryBadge');
                if (badge) {
                    badge.textContent = strategyCategory;
                    if (isPlatinumAsset) {
                        badge.className = 'text-[9px] font-bold bg-indigo-600 text-white rounded-full px-2 py-0.5 uppercase tracking-wider glow-indigo ml-2';
                    } else if (strategyCategory === 'Premium') {
                        badge.className = 'text-[9px] font-bold bg-primary text-black rounded-full px-2 py-0.5 uppercase tracking-wider ml-2';
                    } else {
                        badge.className = 'text-[9px] font-bold bg-slate-700 text-slate-300 rounded-full px-2 py-0.5 uppercase tracking-wider ml-2';
                    }
                }

                // Show admin notes (Admin Only UI check + API check)
                if (isAdmin && strat.adminNotes) {
                    let notes = strat.adminNotes;
                    const mapping = { 'XAUUSDT': '[XAU / GOLD]', 'SPXUSDT': '[SPX / SPY]', 'SPYUSDT': '[SPX / SPY]', 'NQUSDT': '[NQ / Nasdaq Futures]', 'ESUSDT': '[ES / S&P Futures]' };
                    const header = mapping[symbol];
                    if (header && notes.includes(header)) {
                        const globalHeader = notes.split('[')[0];
                        const start = notes.indexOf(header);
                        let end = notes.indexOf('[', start + 1);
                        if (end === -1) end = notes.length;
                        notes = (globalHeader + notes.substring(start, end)).trim();
                    }
                    document.getElementById('adminNotesSection').classList.remove('hidden');
                    document.getElementById('adminNotesContent').innerText = notes;
                }
            } catch (e) { }

            // Visibility Logic
            const isIndex = ['SPXUSDT', 'NQUSDT', 'ESUSDT'].includes(symbol);
            if (isIndex) {
                if (isAdmin || isPlatinum) {
                    document.getElementById('signalSection').style.display = 'block';
                    document.getElementById('signalPremiumOverlay').style.display = 'none';
                } else {
                    document.getElementById('signalSection').style.display = 'block';
                    document.getElementById('signalPremiumOverlay').style.display = 'flex';
                    const link = document.querySelector('#signalPremiumOverlay a');
                    if (link) link.textContent = 'UPGRADE TO PLATINUM';
                }
            } else {
                if (strategyCategory === 'Premium') {
                    if (isAdmin || isAdvanced || isPlatinum) {
                        document.getElementById('signalSection').style.display = 'block';
                        document.getElementById('signalPremiumOverlay').style.display = 'none';
                    } else {
                        document.getElementById('signalSection').style.display = 'block';
                        document.getElementById('signalPremiumOverlay').style.display = 'flex';
                    }
                } else {
                    document.getElementById('signalSection').style.display = 'block';
                    document.getElementById('signalPremiumOverlay').style.display = 'none';
                }
            }

            // Data Source Notice for Index/Futures assets
            const dataSourceNames = {
                'SPXUSDT': 'æ¨™æ™® 500 (SPY)',
                'NQUSDT': 'ç´æ–¯é”å…‹ 100 æœŸè²¨ (NQ)',
                'ESUSDT': 'æ¨™æ™® 500 æœŸè²¨ (ES)'
            };
            if (dataSourceNames[symbol]) {
                const assetName = dataSourceNames[symbol];
                const source = (symbol === 'NQUSDT' || symbol === 'ESUSDT') ? 'Yahoo Financeï¼ˆå»¶é² 15 åˆ†é˜ï¼‰' : 'CoinGecko';
                const infoMsg = document.createElement('div');
                infoMsg.className = 'mx-4 mb-4 p-3 bg-blue-500/10 border border-blue-500/20 rounded-xl flex items-start gap-2';
                infoMsg.innerHTML = `
                    <span class="material-symbols-outlined text-blue-400 text-sm mt-0.5">info</span>
                    <div class="text-[11px] text-blue-400/90 leading-tight">
                        èªªæ˜ï¼š${assetName} æ•¸æ“šæºè‡ª ${source}ã€‚å›æ¸¬æ¶µè“‹æœ€è¿‘ <b>90 å¤©</b> æ•¸æ“šã€‚
                    </div>
                `;
                document.querySelector('main').insertBefore(infoMsg, document.getElementById('perfGrid').parentNode.nextSibling);
            }


            // Check subscription status
            if (user && token) {
                checkSubStatus(token);
            }

            // Run backtest
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = `Bearer ${token}`;

                const res = await fetch('/api/backtest', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ strategyId, symbol, timeframe })
                });
                const data = await res.json();
                if (data.summary) renderReport(data);
            } catch (err) {
                console.error('Backtest error:', err);
            }
        }

        async function checkSubStatus(token) {
            try {
                const res = await fetch('/api/subscriptions', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const subs = await res.json();

                console.log('[CheckSub] All Subs:', subs);
                console.log(`[CheckSub] Looking for: ID=${strategyId}, Sym=${symbol}, TF=${timeframe}`);

                // Check if subscribed to THIS specific variation (Symbol + Timeframe)
                // Note: Old subscriptions might distinguish only by ID, so be careful.
                // But for new logic (SPX/NAS), we must check symbol.
                const isSubscribed = subs.some(s => {
                    const matchId = s.strategy_id === strategyId;
                    const matchSymbol = (s.symbol === symbol || !s.symbol);
                    const matchTf = (s.timeframe === timeframe || !s.timeframe);

                    // console.log(`[CheckSub] Comparing vs ${s.strategy_id}/${s.symbol}/${s.timeframe}: ID=${matchId}, Sym=${matchSymbol}, TF=${matchTf}`);
                    return matchId && matchSymbol && matchTf;
                });

                console.log('[CheckSub] Match Found?', isSubscribed);

                const btn = document.getElementById('subBtn');
                if (isSubscribed) {
                    btn.textContent = 'å–æ¶ˆè¨‚é–±';
                    btn.className = 'bg-slate-700 text-slate-300 font-bold px-5 py-2 rounded-lg hover:bg-slate-600 transition-all text-sm';
                } else {
                    btn.textContent = 'è¨‚é–±';
                    btn.className = 'bg-primary text-black font-bold px-5 py-2 rounded-lg glow-primary hover:opacity-90 transition-all text-sm';
                }
            } catch (e) {
                console.error('[CheckSub] Error:', e);
            }
        }

        // Expose toggleSubscription to window so we can debug it, 
        // but primarily we will bind it via event listener.
        window.toggleSubscription = async function () {
            console.log('[Subscribe] Button clicked');
            const btn = document.getElementById('subBtn');
            const originalText = btn.textContent;

            // 1. Visual Feedback immediately
            btn.textContent = 'è™•ç†ä¸­...';
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                // FIX: Re-parse params 
                const params = new URLSearchParams(window.location.search);
                const strategyId = params.get('strategy');
                const symbol = params.get('symbol') || 'BTCUSDT';
                const timeframe = params.get('timeframe') || '4h';

                console.log(`[Subscribe] Params: ${strategyId}, ${symbol}, ${timeframe}`);

                const { user, token } = await getUser();
                if (!user) {
                    if (confirm('è«‹å…ˆç™»å…¥æ‰èƒ½è¨‚é–±ã€‚å‰å¾€ç™»å…¥é é¢ï¼Ÿ')) {
                        window.location.href = '/login.html';
                        return;
                    }
                    // Revert button
                    btn.textContent = originalText;
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    return;
                }

                const isSubscribed = originalText === 'å–æ¶ˆè¨‚é–±'; // Use text content as source of truth
                const endpoint = isSubscribed ? '/api/unsubscribe' : '/api/subscribe';
                console.log(`[Subscribe] Sending request to ${endpoint}`);

                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ strategyId, symbol, timeframe })
                });

                if (res.ok) {
                    console.log('[Subscribe] Success');
                    await checkSubStatus(token); // refresh status
                    // Button state is updated by checkSubStatus
                } else {
                    const data = await res.json();
                    console.error('[Subscribe] Error:', data);
                    alert(data.error || 'æ“ä½œå¤±æ•—');
                    // Revert button on error
                    btn.textContent = originalText;
                }
            } catch (e) {
                console.error('[Subscribe] Exception:', e);
                alert('è«‹æ±‚å¤±æ•—ï¼š' + e.message);
                btn.textContent = originalText;
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        };

        // Bind Event Listener safely
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('subBtn');
            if (btn) {
                // Remove old onclick attribute to be safe
                btn.removeAttribute('onclick');
                btn.addEventListener('click', window.toggleSubscription);
            }
        });

        function renderReport(data) {
            const s = data.summary;
            document.getElementById('metricReturn').textContent = `${s.totalReturn > 0 ? '+' : ''}${s.totalReturn}%`;
            document.getElementById('metricDD').textContent = `-${s.maxDrawdown}%`;
            document.getElementById('metricDDLabel').textContent = s.maxDrawdown < 15 ? 'ä½é¢¨éšª' : s.maxDrawdown < 30 ? 'ä¸­é¢¨éšª' : 'é«˜é¢¨éšª';
            document.getElementById('metricPLRatio').textContent = s.plRatio ? s.plRatio.toFixed(2) : '--';
            document.getElementById('metricWinRate').textContent = `${s.winRate}%`;
            document.getElementById('metricPF').textContent = s.profitFactor;
            document.getElementById('metricRF').textContent = s.plRatio ? s.plRatio.toFixed(2) : '--';
            document.getElementById('metricExp').textContent = `${s.expectancy}% / ç­†`;
            document.getElementById('metricHold').textContent = `${s.avgHoldDays} å¤©`;
            document.getElementById('metricTotalTrades').textContent = s.totalTrades;
            document.getElementById('metricWL').textContent = `${s.winningTrades} / ${s.losingTrades}`;
            document.getElementById('periodLabel').textContent = `${s.period.startDate} â†’ ${s.period.endDate}`;

            // Set ROI Period Label based on timeframe
            const roiDays = isIndexSymbol ? 90 : (timeframe === '1h' ? 45 : 180);
            const returnPeriodLabel = document.getElementById('returnPeriodLabel');
            if (returnPeriodLabel) returnPeriodLabel.textContent = isIndexSymbol ? 'å›æ¸¬æ¶µè“‹æœ€è¿‘ 90 å¤©ç¸¾æ•ˆ' : `æœ€è¿‘ ${roiDays} å¤©ç¸¾æ•ˆ`;

            const roiTitlePeriod = document.getElementById('roiTitlePeriod');
            if (roiTitlePeriod) roiTitlePeriod.textContent = isIndexSymbol ? '90D' : `${roiDays}d`;

            // Show latest signal from recent trades
            if (data.recentTrades && data.recentTrades.length > 0) {
                const latest = data.recentTrades[0];
                document.getElementById('signalSection').style.display = 'block';
                const signalType = document.getElementById('signalType');

                // Simplified: Signal is the type of the last entry
                const isBuy = latest.type === 'LONG';
                signalType.textContent = isBuy ? 'BUY' : 'SELL';
                signalType.className = `text-3xl font-black italic ${isBuy ? 'text-primary' : 'text-red-500'}`;

                const price = latest.entryPrice;
                const precision = price < 1 ? 4 : 2;
                document.getElementById('signalPrice').textContent = `@ $${price.toLocaleString('en-US', { minimumFractionDigits: precision, maximumFractionDigits: precision })}`;
                const entryDate = new Date(latest.entryTime);
                const timeStr = entryDate.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false });
                document.getElementById('signalTime').querySelector('span:last-child').textContent = `ä¿¡è™Ÿæ™‚é–“ï¼š${timeStr}`;

                // Apply blur for non-premium users ONLY on Premium/Platinum strategies
                const isPremiumStrategy = strategyCategory === 'Premium' || strategyCategory === 'Platinum';
                const isPremiumUser = userRole === 'advanced' || userRole === 'admin' || userRole === 'platinum';

                if (isPremiumStrategy && !isPremiumUser) {
                    document.getElementById('signalContent').classList.add('premium-blur');
                    document.getElementById('signalPremiumOverlay').style.display = 'flex';
                }
            }

            // Render equity chart
            renderChart(data.equityCurve);

            // Render trade list
            renderTrades(data.recentTrades);
        }

        function renderChart(equityCurve) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            if (equityChart) equityChart.destroy();

            // Trim leading flat-line (no trades)
            let startIndex = 0;
            if (equityCurve.length > 0) {
                const initialEquity = equityCurve[0].equity;
                // Find first index where equity changes significantly (e.g. trade execution)
                // Or just first non-initial value.
                const firstChange = equityCurve.findIndex(p => Math.abs(p.equity - initialEquity) > 0.01);
                if (firstChange > 0) {
                    // Start a bit before the first change to show context, but not the whole empty period
                    startIndex = Math.max(0, firstChange - 5);
                }
            }

            const relevantData = equityCurve.slice(startIndex);

            const labels = relevantData.map(p => {
                const d = new Date(p.time);
                return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:00`;
            });
            const values = relevantData.map(p => p.equity);

            equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Equity ($)',
                        data: values,
                        borderColor: '#EAB308',
                        backgroundColor: 'rgba(234, 179, 8, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `$${ctx.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 2 })}`
                            }
                        }
                    },
                    scales: {
                        x: { display: true, ticks: { color: '#666', maxTicksLimit: 8 }, grid: { color: '#2a362a33' } },
                        y: { display: true, ticks: { color: '#666', callback: v => '$' + v.toLocaleString() }, grid: { color: '#2a362a33' } }
                    }
                }
            });
        }

        function renderTrades(trades) {
            const container = document.getElementById('tradeList');
            container.innerHTML = '';
            if (!trades) return;

            // For non-premium users on Premium strategies, skip the first 2 trades
            // For non-premium users on Premium/Platinum strategies, skip the first 2 trades
            const isPremiumUser = userRole === 'advanced' || userRole === 'admin' || userRole === 'platinum';
            const isPremiumStrategy = strategyCategory === 'Premium' || strategyCategory === 'Platinum';
            const shouldHideTrades = isPremiumStrategy && !isPremiumUser;
            const tradesToShow = shouldHideTrades ? trades.slice(2, 15) : trades.slice(0, 15);

            // Show premium notice for hidden trades
            if (shouldHideTrades && trades.length > 0) {
                const notice = document.createElement('div');
                notice.className = 'bg-primary/5 border border-primary/30 rounded-xl p-4 mb-3 text-center';
                notice.innerHTML = `
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <span class="material-symbols-outlined text-primary text-xl">lock</span>
                        <p class="text-white font-bold text-sm">æœ€è¿‘ 2 ç­†äº¤æ˜“å·²éš±è—</p>
                    </div>
                    <p class="text-slate-400 text-xs mb-3">å‡ç´šé€²éšæœƒå“¡ä»¥æŸ¥çœ‹æ‰€æœ‰è¿‘æœŸäº¤æ˜“</p>
                    <a href="/profile.html" class="inline-block bg-primary text-black px-4 py-2 rounded-lg font-bold text-xs hover:opacity-90 transition-all">ç«‹å³å‡ç´š</a>
                `;
                container.appendChild(notice);
            }

            tradesToShow.forEach(t => {
                const isProfit = t.pnlPercent > 0;
                const isLong = t.type === 'LONG';
                const badgeBg = isLong ? 'bg-primary/20 text-primary' : 'bg-orange-500/20 text-orange-400';
                const isClosed = !!t.exitPrice;

                // Granville Rules Mapping
                const ruleMap = {
                    'S1': 'çªç ´å‡ç·š (Golden Cross)',
                    'S4': 'è² ä¹–é›¢å›è£œ (Deviation Reversion)',
                    'S5': 'è·Œç ´å‡ç·š (Death Cross)',
                    'S2': 'å›è¸©å‡ç·š (Bounce)',
                    'S3': 'è¶¨å‹¢è¿½è²· (Bull)'
                };
                const ruleDesc = t.rule ? (ruleMap[t.rule] || t.rule) : 'æ³¢æ®µç­–ç•¥ä¿¡è™Ÿ';

                // Price formatting
                const pricePrecision = (t.entryPrice || 0) < 1 ? 4 : ((t.entryPrice || 0) < 100 ? 2 : 0);
                const entryFormatted = t.entryPrice?.toLocaleString('en-US', { minimumFractionDigits: pricePrecision, maximumFractionDigits: pricePrecision });
                const exitFormatted = t.exitPrice?.toLocaleString('en-US', { minimumFractionDigits: pricePrecision, maximumFractionDigits: pricePrecision });

                // Time formatting
                const fmtTime = (ts) => {
                    if (!ts) return '--';
                    return new Date(ts).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false });
                };

                // Hold duration
                let holdStr = '';
                if (t.entryTime && t.exitTime) {
                    const holdMs = new Date(t.exitTime).getTime() - new Date(t.entryTime).getTime();
                    const holdHours = Math.floor(holdMs / (1000 * 60 * 60));
                    const holdDays = Math.floor(holdHours / 24);
                    const holdRemainder = holdHours % 24;
                    holdStr = holdDays > 0 ? `${holdDays}d ${holdRemainder}h` : `${holdHours}h`;
                }

                // Status badge
                const statusBadge = isClosed
                    ? `<span class="px-1.5 py-0.5 rounded bg-slate-700 text-slate-300 text-[9px] font-bold">CLOSED å¹³å€‰</span>`
                    : `<span class="px-1.5 py-0.5 rounded bg-primary/20 text-primary text-[9px] font-bold animate-pulse">OPEN æŒå€‰ä¸­</span>`;

                const div = document.createElement('div');
                div.className = 'bg-surface-dark border border-border-dark p-4 rounded-xl hover:border-primary/30 transition-all';
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="px-1.5 py-0.5 rounded ${badgeBg} text-[10px] font-bold">${t.type}</span>
                            <span class="text-sm font-bold text-white">${symbol.replace('USDT', '/USDT')}</span>
                            ${statusBadge}
                        </div>
                        <p class="${isProfit ? 'text-primary' : 'text-red-500'} font-black text-base">${isProfit ? '+' : ''}${t.pnlPercent}%</p>
                    </div>
                    <div class="flex items-center gap-1.5 text-[11px] text-slate-400 mb-1.5">
                        <span class="material-symbols-outlined text-[14px]">tune</span>
                        <span class="font-medium">${ruleDesc}</span>
                    </div>
                    <div class="flex items-center gap-1 text-[10px] text-slate-500 font-mono">
                        <span class="text-slate-400">$${entryFormatted}</span>
                        ${isClosed ? `<span class="material-symbols-outlined text-[12px] text-slate-600">arrow_forward</span>
                        <span class="${isProfit ? 'text-primary' : 'text-red-400'}">$${exitFormatted}</span>` : ''}
                    </div>
                    ${isClosed ? `<div class="flex items-center gap-3 mt-2 text-[10px] text-slate-600">
                        <span class="flex items-center gap-0.5"><span class="material-symbols-outlined text-[11px]">schedule</span>${fmtTime(t.entryTime)} â†’ ${fmtTime(t.exitTime)}</span>
                        <span class="flex items-center gap-0.5"><span class="material-symbols-outlined text-[11px]">timer</span>${holdStr}</span>
                    </div>` : `<div class="flex items-center gap-1 mt-2 text-[10px] text-slate-600">
                        <span class="material-symbols-outlined text-[11px]">schedule</span>${fmtTime(t.entryTime)}
                    </div>`}
                `;
                container.appendChild(div);
            });
        }

        async function init() {
            if (typeof updateHeaderAuth === 'function') updateHeaderAuth();
            await loadData();

            // Show admin nav link for admins only
            const { user, token } = await getUser();
            if (user && token && (userRole === 'admin' || isAdmin(user))) {
                const adminLink = document.getElementById('adminNavLink');
                if (adminLink) {
                    adminLink.classList.remove('hidden');
                    adminLink.classList.add('flex');
                }
            }
        }

        init();
    </script>
</body>

</html>